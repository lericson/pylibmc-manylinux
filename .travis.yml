sudo: required
services:
- docker
env:
  global:
  - VERSION="1.5.2"
  - PY27="cp27-cp27mu"
  - PY35="cp35-cp35m"
  - PY36="cp36-cp36m"
  - PY37="cp37-cp37m"
before_install:
- docker pull quay.io/pypa/manylinux1_x86_64
- docker run --name "aaa" quay.io/pypa/manylinux1_x86_64 /bin/sh -c "cd && yum update -y && mkdir /wheelhouse &&
  yum install cyrus-sasl-devel zlib-devel wget -y &&
  wget https://launchpad.net/libmemcached/1.0/1.0.18/+download/libmemcached-1.0.18.tar.gz &&
  tar -xvf libmemcached-1.0.18.tar.gz &&
  cd libmemcached-1.0.18 &&
  ./configure &&
  make &&
  make install&& 
  cd ../ &&
  /opt/python/${PY27}/bin/pip install --upgrade auditwheel &&
  /opt/python/${PY35}/bin/pip install --upgrade auditwheel &&
  /opt/python/${PY36}/bin/pip install --upgrade auditwheel &&
  /opt/python/${PY37}/bin/pip install --upgrade auditwheel &&
  git clone -b ${VERSION} git://github.com/lericson/pylibmc/ && cd pylibmc &&
  /opt/python/${PY27}/bin/pip wheel . -w /wheelhouse &&
  auditwheel repair /wheelhouse/pylibmc-${VERSION}-${PY27}-linux_x86_64.whl -w /wheelhouse &&
  /opt/python/${PY35}/bin/pip wheel . -w /wheelhouse &&
  auditwheel repair /wheelhouse/pylibmc-${VERSION}-${PY35}-linux_x86_64.whl -w /wheelhouse &&
  /opt/python/${PY36}/bin/pip wheel . -w /wheelhouse &&
  auditwheel repair /wheelhouse/pylibmc-${VERSION}-${PY36}-linux_x86_64.whl -w /wheelhouse &&
  /opt/python/${PY37}/bin/pip wheel . -w /wheelhouse &&
  auditwheel repair /wheelhouse/pylibmc-${VERSION}-${PY37}-linux_x86_64.whl -w /wheelhouse"
- docker cp aaa:/wheelhouse/pylibmc-${VERSION}-${PY27}-manylinux1_x86_64.whl ./
- docker cp aaa:/wheelhouse/pylibmc-${VERSION}-${PY35}-manylinux1_x86_64.whl ./
- docker cp aaa:/wheelhouse/pylibmc-${VERSION}-${PY36}-manylinux1_x86_64.whl ./
- docker cp aaa:/wheelhouse/pylibmc-${VERSION}-${PY37}-manylinux1_x86_64.whl ./
script:
- ls
deploy:
  provider: releases
  api_key:
    secure: "hb9/8JHZfMtUD/XYDkaP158HPhQ0ve12rnE6fEeFjeD6r4fQ4IMUvtSyx+8LLYmG4pP1fZRkmPQKmGGSaIt+eVMLwW1gFdvHN9pCmQeEg5gEh2IPOniK+LIHygR8GASA7SyvhtxH+uLuV2hQiCtsvbzHxIEAPokBYADFxsEgh88="
  file:
    - "pylibmc-${VERSION}-${PY27}-manylinux1_x86_64.whl"
    - "pylibmc-${VERSION}-${PY35}-manylinux1_x86_64.whl"
    - "pylibmc-${VERSION}-${PY36}-manylinux1_x86_64.whl"
    - "pylibmc-${VERSION}-${PY37}-manylinux1_x86_64.whl"
  skip_cleanup: true
  overwrite: true
  on:
    repo: lericson/pylibmc-manylinux
